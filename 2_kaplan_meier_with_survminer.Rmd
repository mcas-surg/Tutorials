---
title: 'Basic Kaplan-Meier curves using survminer'
author: "Matthew Castelo"
date: "June, 2021"
output:
  pdf_document:
    fig_caption: yes
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(formatR)
library(knitr)
knitr::opts_chunk$set(tidy = FALSE, 
                      message = FALSE, warning = FALSE,
                      out.width = "75%", fig.align = 'center')
```

**ggplot2** is well suited to creating high-quality Kaplan-Meier plots through the **survminer** package. This tutorial will explore KM plots when the full survival analysis may be performed with a different statistical software.

We will need to install the following packages. 

```{r, eval = FALSE}
install.packages(c("tidyverse", "survminer"))
```

As usual, we will load our packages and set the working directory. 

```{r}
library(tidyverse)
library(survminer)
library(ggsci)
library(survival)

#The working directory saves the following path when loading files, saving plots, etc
setwd("C:/Users/matth/Documents/R/R code and education/Tutorials/")
```

We will be working with a simulated dataset representing 80 generic cancer patients. The dataset can be loaded directly from GitHub so all the subsequent code will run on your computer. 

```{r}
urlRemote  <- "https://raw.githubusercontent.com/"
pathGithub <- "mcas-surg/Tutorials/main/Datasets/"
fileName   <- "generic_cancer.csv"

cancer <- read_csv(paste0(urlRemote, pathGithub, fileName))
```

Let's inspect the dataset. 

```{r}
glimpse(cancer)
```

Assuming our full survival analysis has been performed elsewhere, the main outcome variables of interest will be "vital_status" and "follow_up". For this example we will assume the main exposure variable of interest is a "high_grade" tumour. 

First, we can explore the data. Using **dplyr** we can `select()` the variables of interest and produce summary statistics using `summary()`. Remember to pipe ( %>% ) everything together for efficiency. 

```{r}
cancer %>% 
  select(high_grade, vital_status, follow_up) %>% 
  summary()
```

This didn't give us much useful information, probably because both "vital_status" and "high_grade" are character variables. 

```{r}
#A dollar sign after the dataset name allows you to select a single variable
is.character(cancer$high_grade)
```

We can convert both into factors using `mutate()`. Let's save the new dataset as *cancer_1*. 

```{r}
cancer_1 <- cancer %>% 
  mutate(high_grade = factor(high_grade),
         vital_status = factor(vital_status))
```

And we will try again. 

```{r}
cancer_1 %>% 
  select(high_grade, vital_status, follow_up) %>% 
  summary()
```

We can visualize these results using bar charts and boxplots. 

```{r}
cancer_1 %>% 
  ggplot(aes(y = high_grade, fill = vital_status))+
  geom_bar()+
  labs(x = "Number of patients",
       y = "Patient had high grade tumour",
       fill = "Vital status")+
  coord_flip()+
  theme_bw()+
  scale_fill_d3()+
  theme(panel.grid = element_blank())
```

```{r}
cancer_1 %>% 
  ggplot(aes(y = follow_up, fill = high_grade))+
  geom_boxplot(alpha = 0.7)+
  labs(x = " ",
       y = "Follow-up time (months)",
       fill = "High grade tumour")+
  theme_bw()+
  scale_fill_aaas()+
  theme(panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "bottom")
```

It appears patients with high grade tumours have worse survival. Let's create our KM curve. First we need to create a survival curve. The equation has two sides, separated by a `~`. On the left side we provide our variable indicating follow-up time, and the status variable (death or censored). On the right we provide the stratification variable. 

First, **survminer** does not like factors, we need to change our variables into binary 1's and 0's. We will call this new dataset *cancer_surv*. 

```{r}
cancer_surv <- cancer %>% 
  mutate(high_grade = ifelse(high_grade == "Yes",
                             1, 0),
         vital_status = ifelse(vital_status == "Died",
                               1, 0))

survival_curve <- survfit(Surv(follow_up, vital_status) ~ high_grade,
                          data = cancer_surv)
```

Now let's create a basic KM plot. 

```{r}
ggsurvplot(survival_curve, 
           data = cancer_surv)
```

There are a few improvements we can make immediately. Let's rename the Strata groups, and change the y-axis to percent rather than probability. We will also use the Lancet colour scheme. 

```{r}
ggsurvplot(survival_curve, 
           data = cancer_surv,
           legend.labs = c("High grade tumour",
                           "Low grade tumour"),
           surv.scale = "percent",
           palette = "lancet")
```

Now, let's improve the x-axis breaks and rename the x-axis. We will also change the censor markings to vertical lines and add confidence bands. Finally, the legend will be positioned at the bottom of the plot and renamed.

```{r}
ggsurvplot(survival_curve, 
           data = cancer_surv,
           legend.labs = c("High grade tumour",
                           "Low grade tumour"),
           surv.scale = "percent",
           palette = "lancet",
           break.x.by = 10,
           xlab = "Follow-up time (months)",
           censor.shape = "|",
           conf.int = T,
           conf.int.alpha = 0.15,
           legend = "bottom",
           legend.title = "Group")
```

We can add a p-value to the plot and customize the position. It is also advisable to add an at-risk table to the KM curve. Here I have chosen to place the table inside the figure, but it can also be placed outside with the argument `risk.table.pos = "out"`. 

```{r}
final_km <- ggsurvplot(survival_curve, 
           data = cancer_surv,
           legend.labs = c("High grade tumour",
                           "Low grade tumour"),
           surv.scale = "percent",
           palette = "lancet",
           break.x.by = 10,
           xlab = "Follow-up time (months)",
           censor.shape = "|",
           conf.int = T,
           conf.int.alpha = 0.15,
           legend = "bottom",
           legend.title = "Group",
           pval = TRUE,
           pval.coord = c(60, .15),
           risk.table = TRUE,
           risk.table.pos = "in")
```
```{r, echo=FALSE, out.width="100%"}
ggsave("Photos/final_km.png", plot = print(final_km), 
       dpi = 300, dev = "png",
       height = 20, width = 30, units = "cm")

knitr::include_graphics("C:/Users/matth/Documents/R/R code and education/Tutorials/Photos/final_km.png")
```

Remember to save a publication-quality version of your figure. Note there is a requirement to wrap the name of the plot in `print()` for it to save correctly. 

```{r, eval = FALSE}
#If you have not set the working directory, include the full file path
ggsave("my_plot.png", plot = print(final_km), 
       dpi = 300, dev = "png",
       height = 20, width = 30, units = "cm")
```

This was a brief overview of creating KM plots using the **survminer** package in R. Although these plots can be created in other software, if you are using **ggplot2** for other figures, this method may help your manuscript maintain a consistent style, colour palette, and resolution across all figures. 

One limitation is the need to start from a survival curve using the `survfit()` function. If you have undertaken more complicated analyses in other software and have the ability to produce the raw coordinates, survival curves can still be created in **ggplot2**, including at-risk tables using more complex code. This will be covered in later tutorials. 